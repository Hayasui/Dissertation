---
title: "Dissertation Regression Tables (Significant Terms Only)"
author: "Huixian"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
---

<style>
  body {
    font-size: 12pt;
  }
  .table-title {
    font-weight: bold;
    font-size: 1.2em;
    margin-bottom: 10px;
  }
</style>

# Introduction

This document is dedicated to generating dissertation-ready regression tables from the models created in the `Graphs and charts.Rmd` analysis. The tables are generated using the `sjPlot` package for high-quality HTML output that can be easily copied into a Microsoft Word document.

This version has been modified to display **only statistically significant predictors (p < 0.05)** for greater clarity in the final output.

# Setup

First, we load the necessary libraries and the saved R environment containing the regression models and data. The `broom` library has been added to facilitate the filtering of model terms.

```{r setup, include=FALSE}
# Load necessary libraries
library(sjPlot)   
library(betareg)  
library(dplyr)
library(knitr) # For creating the summary table
library(broom) # Added for using the tidy() function to filter models

# Load the R environment which contains all models and data.
# Note: Ensure you have run the 'Graphs and charts.r' script first to generate this file.
load("C:/Users/Gairui/OneDrive - University College London/Dissertation/Data Analysis/R Code/Graphs and Charts/regression_models.RData")
```

```{r debug-terms, echo=TRUE}
# Check what broom::tidy returns vs actual coefficient names
cat("=== Checking term name matching ===\n")
tidy_terms <- broom::tidy(model1)
model_coef_names <- rownames(summary(model1)$coefficients$mean)

cat("3D_ARPG from tidy:", tidy_terms$term[grepl("3D_ARPG", tidy_terms$term)], "\n")
cat("3D_ARPG from model:", model_coef_names[grepl("3D_ARPG", model_coef_names)], "\n")

# Show all non-significant terms from both methods
tidy_nonsig <- tidy_terms %>% filter(p.value >= 0.05) %>% pull(term)
summary_pvals <- summary(model1)$coefficients$mean[, "Pr(>|z|)"]
summary_nonsig <- names(summary_pvals)[summary_pvals >= 0.05]

cat("Non-sig from tidy:\n")
print(tidy_nonsig)
cat("\nNon-sig from summary:\n") 
print(summary_nonsig)
```

```{r define-labels, include=FALSE}
# Define a comprehensive named vector for custom predictor labels.
# This makes maintenance easier and ensures consistency.

# NEW: Programmatically generate labels for release years.
# Assuming years range from 2011 to 2023. Adjust the range if needed.
year_range <- 2010:2025 
year_labels <- setNames(
  paste("Game Release Year:", year_range), 
  paste0("release_year", year_range)
)

# Define base labels for predictors
custom_labels_base <- c(
  # Localisation Levels
  "full_localisation_comboAudio + Text" = "Audio + Text Localisation",
  "full_localisation_comboText Only" = "Text Localisation",
  
  # Control Variables
  "log_total_reviews" = "Log of Total Reviews",
  
  # Genre Factors from Factor Analysis
  "Management_City_Builder" = "Genre: Management / City Builder",
  "Narrative_Driven_Visual_Novel" = "Genre: Narrative / Visual Novel",
  "Adult_Hentai" = "Genre: Adult / Hentai",
  "Roguelite_Deckbuilder" = "Genre: Roguelite / Deckbuilder",
  "Local_Multiplayer" = "Genre: Local Multiplayer",
  "Action_Roguelike_Bullet_Hell" = "Genre: Action Roguelike / Bullet Hell",
  "Racing_Driving_Sim" = "Genre: Racing / Driving Sim",
  "Horror_Games" = "Genre: Horror",
  "Grand_Strategy_Wargame" = "Genre: Grand Strategy / Wargame",
  "Cozy_Wholesome" = "Genre: Cozy / Wholesome",
  "MMORPG" = "Genre: MMORPG",
  "Puzzle_Games" = "Genre: Puzzle",
  "3D_ARPG" = "Genre: 3D ARPG",
  "Beat_em_up" = "Genre: Beat 'em up",
  "Sci_Fi" = "Genre: Sci-Fi",
  "Metroidvania_2D_Platformer" = "Genre: Metroidvania / 2D Platformer",
  "Retro_Old_School" = "Genre: Retro / Old School",
  "Comedy_Humor" = "Genre: Comedy / Humor",
  "3rd-Person_Investigation" = "Genre: 3rd-Person Infiltration",
  "Cyberpunk_RPG" = "Genre: Cyberpunk RPG",

  # Polynomial Time Terms
  "release_year_centered" = "Release Year (Centered)",
  "release_year_centered_squared" = "Release Year (Centered, Squared)",
  "release_year_centered_cubed" = "Release Year (Centered, Cubed)",
  
  # Hypothesis Moderator Variables
  "text_heavy_game1" = "Is Text-Heavy Game (Yes)",
  "has_indie_genreTRUE" = "Is Indie Game (Yes)",
  
  # Price Categories (USD)
  "price_usd_categoryFree" = "Price (USD): Free",
  "price_usd_categoryBudget/Indie" = "Price (USD): Budget/Indie (<= $10)",
  "price_usd_categoryMajor Release" = "Price (USD): Major Release ($30.01 - $50)",
  "price_usd_categoryPremium AAA" = "Price (USD): Premium AAA (> $50)",
  
  # Price Categories (CNY)
  "price_cny_categoryFree" = "Price (CNY): Free",
  "price_cny_categoryBudget/Indie" = "Price (CNY): Budget/Indie (<= 짜50)",
  "price_cny_categoryMajor Release" = "Price (CNY): Major Release (짜120.01 - 짜200)",
  "price_cny_categoryPremium AAA" = "Price (CNY): Premium AAA (> 짜200)"
)

# NEW: Define labels for all interaction terms
interaction_labels <- c(
  # --- Temporal Interactions (Models 3 & 4) ---
  "full_localisation_comboAudio + Text:release_year_centered" = "Localisation (Audio+Text) x Year",
  "full_localisation_comboAudio + Text:release_year_centered_squared" = "Localisation (Audio+Text) x Year^2",
  "full_localisation_comboAudio + Text:release_year_centered_cubed" = "Localisation (Audio+Text) x Year^3",
  "full_localisation_comboNone:release_year_centered" = "No Localisation x Year",
  "full_localisation_comboNone:release_year_centered_squared" = "No Localisation x Year^2",
  "full_localisation_comboNone:release_year_centered_cubed" = "No Localisation x Year^3",
  
  # --- Text-Heavy Interactions (Models 5 & 6) ---
  "full_localisation_comboAudio + Text:text_heavy_game" = "Localisation (Audio+Text) x Is Text-Heavy",
  "full_localisation_comboNone:text_heavy_game" = "No Localisation x Is Text-Heavy",

  # --- Indie Game Interactions (Models 7 & 8) ---
  "full_localisation_comboAudio + Text:has_indie_genreTRUE" = "Localisation (Audio+Text) x Is Indie",
  "full_localisation_comboNone:has_indie_genreTRUE" = "No Localisation x Is Indie",

  # --- USD Price Interactions (Models 9 & 11) ---
  "full_localisation_comboAudio + Text:price_usd_categoryFree" = "Localisation (Audio+Text) x Price (Free)",
  "full_localisation_comboAudio + Text:price_usd_categoryBudget/Indie" = "Localisation (Audio+Text) x Price (Budget/Indie)",
  "full_localisation_comboAudio + Text:price_usd_categoryMajor Release" = "Localisation (Audio+Text) x Price (Major Release)",
  "full_localisation_comboAudio + Text:price_usd_categoryPremium AAA" = "Localisation (Audio+Text) x Price (Premium AAA)",
  "full_localisation_comboNone:price_usd_categoryFree" = "No Localisation x Price (Free)",
  "full_localisation_comboNone:price_usd_categoryBudget/Indie" = "No Localisation x Price (Budget/Indie)",
  "full_localisation_comboNone:price_usd_categoryMajor Release" = "No Localisation x Price (Major Release)",
  "full_localisation_comboNone:price_usd_categoryPremium AAA" = "No Localisation x Price (Premium AAA)",

  # --- CNY Price Interactions (Models 10 & 12) ---
  "full_localisation_comboAudio + Text:price_cny_categoryFree" = "Localisation (Audio+Text) x Price (Free)",
  "full_localisation_comboAudio + Text:price_cny_categoryBudget/Indie" = "Localisation (Audio+Text) x Price (Budget/Indie)",
  "full_localisation_comboAudio + Text:price_cny_categoryMajor Release" = "Localisation (Audio+Text) x Price (Major Release)",
  "full_localisation_comboAudio + Text:price_cny_categoryPremium AAA" = "Localisation (Audio+Text) x Price (Premium AAA)",
  "full_localisation_comboNone:price_cny_categoryFree" = "No Localisation x Price (Free)",
  "full_localisation_comboNone:price_cny_categoryBudget/Indie" = "No Localisation x Price (Budget/Indie)",
  "full_localisation_comboNone:price_cny_categoryMajor Release" = "No Localisation x Price (Major Release)",
  "full_localisation_comboNone:price_cny_categoryPremium AAA" = "No Localisation x Price (Premium AAA)"
)

# Combine all labels into one final vector
custom_labels_all <- c(custom_labels_base, year_labels, interaction_labels)
```

# Regression Tables (Significant Predictors Only)

```{r table-model1, echo=FALSE, message=FALSE, warning=FALSE}
# Get non-significant terms
model1_summary <- summary(model1)
coef_pvals <- model1_summary$coefficients$mean[, "Pr(>|z|)"]
non_sig_coefs <- names(coef_pvals)[coef_pvals >= 0.05 & !is.na(coef_pvals)]

# Create filtered custom labels that exclude non-significant terms
custom_labels_filtered <- custom_labels_all[!names(custom_labels_all) %in% non_sig_coefs]

tab_model(model1, 
          rm.terms = non_sig_coefs,
          title = "Table 1: Beta Regression (Base Model) Predicting SC Review Proportion",
          dv.labels = "Proportion of SC Reviews (Adjusted)", 
          string.est = "Odds Ratio",
          pred.labels = custom_labels_filtered,  # Use filtered labels
          show.reflvl = FALSE, 
          p.style = "numeric",
          collapse.ci = TRUE, 
          show.r2 = TRUE, 
          show.aic = TRUE)
```

```{r table-model2, echo=FALSE, message=FALSE, warning=FALSE}
# Get coefficient names from the actual model object (more reliable than broom::tidy)
if (inherits(model2, "betareg")) {
  # For betareg models, get p-values from summary
  model2_summary <- summary(model2)
  coef_pvals <- model2_summary$coefficients$mean[, "Pr(>|z|)"]
} else {
  # For lm models
  model2_summary <- summary(model2)
  coef_pvals <- model2_summary$coefficients[, "Pr(>|t|)"]
}

# Get names of non-significant coefficients to remove
non_sig_terms_model2 <- names(coef_pvals)[coef_pvals >= 0.05]

tab_model(model2, 
          rm.terms = non_sig_terms_model2,
          title = "Table 2: WLS Linear Model (Base Model) Predicting Sentiment Gap",
          dv.labels = "Sentiment Gap (SC % Positive - English % Positive)", 
          string.est = "Estimate",
          pred.labels = custom_labels_all, 
          show.reflvl = FALSE, 
          p.style = "numeric",
          collapse.ci = TRUE, 
          show.r2 = TRUE, 
          show.aic = TRUE)
```

```{r table-model3, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model3 <- tidy(model3) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model3, rm.terms = non_sig_terms_model3,
          title = "Table 3: Beta Regression (Temporal Trends) Predicting SC Review Proportion",
          dv.labels = "Proportion of SC Reviews (Adjusted)", string.est = "Odds Ratio",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

```{r table-model4, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model4 <- tidy(model4) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model4, rm.terms = non_sig_terms_model4,
          title = "Table 4: WLS Linear Model (Temporal Trends) Predicting Sentiment Gap",
          dv.labels = "Sentiment Gap (SC % Positive - English % Positive)", string.est = "Estimate",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

```{r table-model5, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model5 <- tidy(model5) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model5, rm.terms = non_sig_terms_model5,
          title = "Table 5: Beta Regression (Text-Heavy Interaction) Predicting SC Review Proportion",
          dv.labels = "Proportion of SC Reviews (Adjusted)", string.est = "Odds Ratio",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

```{r table-model6, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model6 <- tidy(model6) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model6, rm.terms = non_sig_terms_model6,
          title = "Table 6: WLS Linear Model (Text-Heavy Interaction) Predicting Sentiment Gap",
          dv.labels = "Sentiment Gap (SC % Positive - English % Positive)", string.est = "Estimate",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

```{r table-model7, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model7 <- tidy(model7) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model7, rm.terms = non_sig_terms_model7,
          title = "Table 7: Beta Regression (Indie Game Interaction) Predicting SC Review Proportion",
          dv.labels = "Proportion of SC Reviews (Adjusted)", string.est = "Odds Ratio",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

```{r table-model8, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model8 <- tidy(model8) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model8, rm.terms = non_sig_terms_model8,
          title = "Table 8: WLS Linear Model (Indie Game Interaction) Predicting Sentiment Gap",
          dv.labels = "Sentiment Gap (SC % Positive - English % Positive)", string.est = "Estimate",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

```{r table-model10, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model10 <- tidy(model10) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model10, rm.terms = non_sig_terms_model10,
          title = "Table 10: Beta Regression (CNY Price Interaction) Predicting SC Review Proportion",
          dv.labels = "Proportion of SC Reviews (Adjusted)", string.est = "Odds Ratio",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

```{r table-model12, echo=FALSE, message=FALSE, warning=FALSE}
non_sig_terms_model12 <- tidy(model12) %>% filter(p.value >= 0.05) %>% pull(term)
tab_model(model12, rm.terms = non_sig_terms_model12,
          title = "Table 12: WLS Linear Model (CNY Price Interaction) Predicting Sentiment Gap",
          dv.labels = "Sentiment Gap (SC % Positive - English % Positive)", string.est = "Estimate",
          pred.labels = custom_labels_all, show.reflvl = FALSE, p.style = "numeric",
          collapse.ci = TRUE, show.r2 = TRUE, show.aic = TRUE)
```

# Model Fit Summary

```{r r-squared-comparison, echo=FALSE, message=FALSE, warning=FALSE}
# Get all model objects from the environment
model_list <- mget(ls(pattern = "model[0-9]+"))
# Sort list by model number
model_list <- model_list[order(as.numeric(gsub("model", "", names(model_list))))]

# Initialize a list to store the results
results_list <- list()

for (model_name in names(model_list)) {
  model <- model_list[[model_name]]
  
  if (inherits(model, "betareg")) {
    r_squared_val <- summary(model)$pseudo.r.squared
    metric_name <- "Pseudo R-squared"
    model_type <- "Beta Regression"
    dv <- "SC Review Ratio"
  } else if (inherits(model, "lm")) {
    r_squared_val <- summary(model)$adj.r.squared
    metric_name <- "Adjusted R-squared"
    model_type <- "WLS Linear Model"
    dv <- "Sentiment Gap"
  } else {
    next 
  }
  
  results_list[[model_name]] <- data.frame(
    Model = model_name,
    `Dependent Variable` = dv,
    `Model Type` = model_type,
    `Goodness-of-Fit Metric` = metric_name,
    Value = round(r_squared_val, 4),
    stringsAsFactors = FALSE,
    check.names = FALSE
  )
}

# Combine the list into a single data frame
r_squared_summary_df <- do.call(rbind, results_list)
rownames(r_squared_summary_df) <- NULL

# Display the summary table using knitr::kable for a clean look
kable(r_squared_summary_df, 
      caption = "Table 13: Comparison of Goodness-of-Fit Across All Regression Models",
      align = 'lcccc')
```
````